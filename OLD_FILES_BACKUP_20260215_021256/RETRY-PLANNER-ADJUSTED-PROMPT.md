# Retry Planner - Adjusted Prompt Output ‚úÖ

## Overview

The retry-planner agent now generates a **complete adjusted prompt** for the migration-planner, which **REPLACES** the original prompt entirely (not just appended as context).

## How It Works

### 1. **Retry-Planner Analyzes Errors**

When validation errors are found:
```typescript
const improvement = await retryPlannerService.analyzeAndImprove({
  originalMigrationPlan: migrationPlan,
  unitTestReport: unitTestOutput,
  integrationTestReport: integrationTestOutput,
  e2eTestReport: e2eTestOutput,
  currentAttempt,
  maxRetries
});
```

### 2. **Retry-Planner Returns Adjusted Prompt** ‚≠ê **NEW!**

The ARK agent returns a JSON with:
```json
{
  "analysis": {
    "totalErrors": 25,
    "criticalErrors": 8,
    "errorsByCategory": {...},
    "rootCauses": [...]
  },
  "adjustedMigrationPlannerPrompt": "**ADJUSTED MIGRATION PLANNING PROMPT - Retry Attempt 2/3**\n\nYou are creating a migration plan to fix validation errors from the previous attempt.\n\n## CRITICAL FIXES REQUIRED\n\n1. **PostgreSQL Driver** (Priority: CRITICAL)\n   - Add org.postgresql:postgresql to ALL microservice pom.xml files\n   - Impact: Fixes 8 database connection errors\n\n2. **CORS Configuration** (Priority: HIGH)\n   - Configure CORS in API Gateway with allowed origins: http://localhost:4200\n   - Impact: Fixes 5 API endpoint errors\n\n## MANDATORY REQUIREMENTS\n\n### For ALL Microservices:\n- MUST include PostgreSQL driver dependency\n- MUST have proper database connection URLs\n- MUST have @SpringBootTest annotations in tests\n\nCreate a comprehensive migration plan that addresses ALL these requirements.",
  "improvementStrategy": {...},
  "improvedMigrationPlan": {...},
  "retryConfidence": {...}
}
```

**Key Field**: `adjustedMigrationPlannerPrompt` - A complete new prompt that will REPLACE the original

### 3. **Store Adjusted Prompt**

```typescript
// Store the ADJUSTED PROMPT generated by retry-planner
const adjustedPrompt = improvement.adjustedMigrationPlannerPrompt;

// Store it in migration object
(migration as any).adjustedMigrationPlannerPrompt = adjustedPrompt;
```

### 4. **Migration-Planner Uses Adjusted Prompt** ‚≠ê

When migration-planner is invoked:

```typescript
// Check if this is a retry with adjusted prompt from retry-planner
const adjustedPrompt = (migration as any).adjustedMigrationPlannerPrompt;

const plannerResult = await arkChatService.createMigrationPlanWithARK(
  analysis,
  actualRepoPath,
  adjustedPrompt  // Pass adjusted prompt
);
```

**In arkChatService.ts**:

```typescript
async createMigrationPlanWithARK(
  analysis: any,
  repoPath: string,
  adjustedPrompt?: string  // NEW PARAMETER
) {
  let userMessage = '';

  // If adjusted prompt exists, USE IT INSTEAD of building default prompt
  if (adjustedPrompt) {
    logger.info('‚úÖ Using adjusted prompt from retry-planner (REPLACES original)');
    userMessage = adjustedPrompt;  // COMPLETE REPLACEMENT
    // Add code analysis context for reference
    userMessage += `\n\n---\n## CODE ANALYSIS CONTEXT\n\n`;
    userMessage += `**Repository Path:** ${repoPath}\n`;
    userMessage += `**Framework:** ${analysis.framework}\n\n`;
  } else {
    // Build default prompt (first attempt)
    userMessage = `**MIGRATION PLANNING REQUEST**\n\n...`;
  }

  // Call ARK agent with the prompt
  ...
}
```

**Result**: Migration-planner receives the retry-planner's custom prompt that specifically addresses the validation errors!

---

## Complete Flow

### First Attempt (No Errors)

```
1. Migration-planner receives DEFAULT prompt
   ‚Üì
2. Creates initial migration plan
   ‚Üì
3. Service-generator & frontend-migrator generate code
   ‚Üì
4. Validators pass ‚úÖ
   ‚Üì
5. Success!
```

### Retry Attempt (Errors Found)

```
1. Validators find 25 errors ‚ùå
   ‚Üì
2. Retry-planner analyzes errors
   ‚Üì
3. Retry-planner generates ADJUSTED PROMPT:
   "Fix these 25 errors:
   - Add PostgreSQL driver to ALL microservices
   - Configure CORS in API Gateway
   - Fix Module Federation paths
   ..."
   ‚Üì
4. Migration-planner receives ADJUSTED PROMPT (replaces original)
   ‚Üì
5. Creates IMPROVED migration plan with fixes
   ‚Üì
6. Service-generator & frontend-migrator generate NEW code
   ‚Üì
7. Validators run again
   ‚Üì
8. Fewer errors (or ZERO!) ‚úÖ
```

---

## Adjusted Prompt Example

**Original Prompt (First Attempt)**:
```
**MIGRATION PLANNING REQUEST**

**Repository Path:** /repo/path
**Framework:** Spring Boot + Blazor

## CODE ANALYSIS RESULTS

### Domain Entities (5)
- Client
- Account
- Transaction
- Card
- User

### REST Controllers (4)
...

Create a comprehensive migration plan to transform this application into microservices and micro-frontends.
```

**Adjusted Prompt (Retry Attempt 2)**:
```
**ADJUSTED MIGRATION PLANNING PROMPT - Retry Attempt 2/3**

You are creating a migration plan to fix validation errors from the previous attempt.

## CRITICAL FIXES REQUIRED

1. **PostgreSQL Driver** (Priority: CRITICAL)
   - Add org.postgresql:postgresql to ALL microservice pom.xml files
   - Impact: Fixes 8 database connection errors
   - Mandatory: EVERY microservice MUST include this dependency

2. **CORS Configuration** (Priority: HIGH)
   - Configure CORS in API Gateway with allowed origins: http://localhost:4200
   - Impact: Fixes 5 API endpoint errors
   - Mandatory: API Gateway MUST have proper CORS settings

3. **Module Federation Paths** (Priority: HIGH)
   - Fix remoteEntry.js paths in webpack.config.js
   - Correct paths: http://localhost:4201/remoteEntry.js (auth-mfe)
   - Impact: Fixes 6 frontend loading errors

## MANDATORY REQUIREMENTS

### For ALL Microservices:
- MUST include PostgreSQL driver dependency:
  ```xml
  <dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
  </dependency>
  ```
- MUST have database connection URLs in application-docker.yml:
  ```yaml
  spring:
    datasource:
      url: jdbc:postgresql://postgres-{service-name}:5432/{db_name}
  ```
- MUST have @SpringBootTest annotations in all test classes
- MUST achieve minimum 70% code coverage

### For API Gateway:
- MUST configure CORS:
  ```java
  @Bean
  public CorsConfigurationSource corsConfigurationSource() {
    CorsConfiguration config = new CorsConfiguration();
    config.addAllowedOrigin("http://localhost:4200");
    config.addAllowedMethod("*");
    config.addAllowedHeader("*");
    return source;
  }
  ```

### For ALL Micro-frontends:
- MUST have correct Module Federation remote paths in webpack.config.js
- MUST configure shared Angular dependencies with singleton: true
- MUST implement proper error handling in all components

---

## CODE ANALYSIS CONTEXT

**Repository Path:** /repo/path
**Framework:** Spring Boot + Blazor

[Code analysis details provided for reference]

---

Create a comprehensive migration plan that addresses ALL the requirements above.
Every fix listed is MANDATORY and must be incorporated into the plan.
```

**Difference**:
- ‚ùå Original: Generic instructions, no specific fixes
- ‚úÖ Adjusted: Specific fixes for exact errors found, with code examples

---

## Frontend Display

When user clicks on retry-planner agent card:

**Agent Output Tab** shows:
```markdown
# Retry Planner Analysis - Attempt 2/3

## Error Analysis Summary
**Total Errors**: 25
**Critical Errors**: 8

## Adjusted Migration Planner Prompt

**This NEW prompt will REPLACE the original migration-planner prompt:**

```
**ADJUSTED MIGRATION PLANNING PROMPT - Retry Attempt 2/3**

You are creating a migration plan to fix validation errors...

## CRITICAL FIXES REQUIRED

1. **PostgreSQL Driver** (Priority: CRITICAL)
   - Add org.postgresql:postgresql to ALL microservice pom.xml files
   ...
```
```

Users can see the **exact adjusted prompt** that will be used!

---

## Files Modified

1. **`ark/agents/retry-planner.yaml`**:
   - Updated to output `adjustedMigrationPlannerPrompt` field
   - Prompt includes specific, actionable fixes
   - Examples show complete adjusted prompts

2. **`platform/backend/src/services/retryPlannerService.ts`**:
   - Added `adjustedMigrationPlannerPrompt: string` to return type
   - Updated validation to check for this field

3. **`platform/backend/src/services/arkChatService.ts`**:
   - Changed parameter from `enhancedContext?` to `adjustedPrompt?`
   - When adjusted prompt exists, it REPLACES original (not appended)
   - Only adds code analysis as context reference

4. **`platform/backend/src/routes/repoMigrationRoutes.ts`**:
   - Stores `adjustedMigrationPlannerPrompt` from retry-planner
   - Passes it to migration-planner instead of enhanced context
   - Updated output display to show adjusted prompt

---

## Benefits

‚úÖ **Complete Control**: Retry-planner has full control over migration-planner's instructions
‚úÖ **Specific Fixes**: Adjusted prompt contains exact code examples and mandatory requirements
‚úÖ **No Generic Instructions**: Migration-planner gets precise guidance, not vague "improve the plan"
‚úÖ **Transparency**: Users can see the exact adjusted prompt in the dashboard
‚úÖ **Better Results**: More targeted instructions = better fixes = fewer errors

---

## Testing

**To test**:
1. Start a migration that will have errors
2. When retry-planner activates, click on its card
3. View **Agent Output** tab
4. See the **Adjusted Migration Planner Prompt** section
5. This prompt will be used to restart migration-planner
6. Migration-planner will generate improved plan with specific fixes

---

## Status

‚úÖ **Retry-planner outputs adjusted prompt** - COMPLETE
‚úÖ **Migration-planner uses adjusted prompt** - COMPLETE
‚úÖ **Original prompt replaced (not appended)** - COMPLETE
‚úÖ **Frontend displays adjusted prompt** - COMPLETE
‚úÖ **ARK agent updated in Kubernetes** - COMPLETE

**Ready to test!** üöÄ
